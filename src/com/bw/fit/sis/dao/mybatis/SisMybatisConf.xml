<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sisAdminDAO">
	<!--用户登录 -->
	<select id="loginCheckAndBackUserInfos" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select st.fdid staff_id,st.staff_name,st.create_time,cp.fdid staff_company_id,cp.company_name staff_company_name,
	rl.fdid role_id ,rl.role_name
	from staff st ,roles rl,company cp ,staff2roles sr, staff2company sc
	where st.fdid = sr.staff_id and sr.role_id = rl.fdid and st.fdid = sc.staff_id 
	and sc.company_id = cp.fdid and st.staff_number = #{staff_number} and st.passwd =#{passwd_mm}
	</select> 
	<!-- 新建申报周期 -->
	<insert id="createSubCycle" parameterType="com.bw.fit.common.models.SystemCommonModel">
	insert into sub_cycle (fdid,cycle_name,org_id,start_date,end_date,isdeleted,state,create_time,version_time,creator)
	values (#{fdid},#{temp_str2},#{temp_str3},to_date(#{start_date},'yyyy-mm-dd'),to_date(#{end_date},'yyyy-mm-dd'),
	'0','2',to_date(#{create_time},'yyyy-mm-dd hh24:mi:ss'),to_date(#{create_time},'yyyy-mm-dd hh24:mi:ss'),#{staff_id})
	</insert>
	<select id="checkCompanyExisteSubCycle" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		   select start_date,end_date ,cp.company_name from sub_cycle sc,company cp 
    where sc.org_id = cp.fdid and org_id =#{temp_str3}  and sc.isdeleted='0'  
		</select>
		<!-- 周期列表 -->
		<select id="qryAllCycleInfoList"  parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select * from ( select fdid,cycle_name,to_char(start_date,'yyyy-MM-dd') start_date, to_char(end_date,'yyyy-MM-dd') end_date,to_char(create_time,'yyyy-MM-dd hh24:mi:ss') create_time,
(select staff_name from staff where fdid = a.creator) temp_str1,
(select company_name from company a where a.fdid = org_id) select_company_name,
(case a.state when '2' then '已开启' when '1' then '已关闭' else '其他' end) temp_str3 ,rownum pageno from sub_cycle a where 1=1
 		 <if test="cycle_name !='-9'">
  				and   cycle_name  like  '%'||#{cycle_name}||'%'   
 		 </if> 
 		 <if test="temp_str1 !='-9'">
 		 and org_id  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 		 </if>
 		 )  cc where 1=1    		
 		 <if test="end_num !='-9'">
  				<![CDATA[  and cc.pageno > #{start_num} and cc.pageno<= #{end_num} ]]>
  		</if>      
		</select>
		<!-- 删除申报周期 -->
		<update id="deleteSubCycle"  parameterType="com.bw.fit.common.models.SystemCommonModel">
		update sub_cycle set isdeleted='1' ,version_time=to_date(#{version_time},'yyyy-mm-dd hh24:mi:ss'),operator=#{staff_id} where 1=1 		
 		 <if test="temp_str1 !='-9'">
 		 and fdid  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 		 </if>
		</update>
		<update id="openOrCloseSubCycle"  parameterType="com.bw.fit.common.models.SystemCommonModel">
		update sub_cycle set state = #{temp_str2} 
		 <if test="temp_str1 !='-9'">
 		 where fdid  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 			</if>
		</update>
		<!-- 根据角色查询拥有的补贴类型 -->
		<select id="getRoleDeSubType"    parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select distinct type_cd fdid from role2sub_type where role_id =#{role_id}		
		</select>
		<delete id="deleteRoleDeSubType"   parameterType="com.bw.fit.common.models.SystemCommonModel">
		delete from role2sub_type where role_id =#{role_id}		
		</delete>
		<!-- 角色与类型进行关联 -->
		<insert id="createRole2SubType"  parameterType="com.bw.fit.common.models.SystemCommonModel">
		insert into role2sub_type (role_id,type_cd) values (#{role_id},#{temp_str3})
		</insert>
		<!-- 查询申报人基础信息 -->
		<select id="getPsnBaseInfo"  parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
    select a.person_name person_name ,a.phone person_phone,a.gender person_gender,a.nation person_nation,a.orgin person_orgin,to_char(a.first_time,'yyyy-MM-dd') first_time,a.state person_state,
(select company_name from company where fdid = a.create_company) select_company_name,
(select staff_name from staff where fdid = a.creator) staff_name ,
a.create_time from rpt_person  a where card_id = #{card_id}   
		</select>
		<!-- 修改申报人基础信息 -->
		<update id="changePsnBaseInfo" parameterType="com.bw.fit.common.models.SystemCommonModel" 	>
		update rpt_person  set person_name=#{person_name},phone=#{person_phone},gender=#{person_gender},first_time=to_date(#{first_time},'yyyy-MM-dd'),
state = #{person_state} where card_id = #{card_id}
		</update>
</mapper>