<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sisAdminDAO">
	<!--用户登录 -->
	<select id="loginCheckAndBackUserInfos" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select st.fdid staff_id,st.staff_name,st.create_time,cp.fdid staff_company_id,cp.company_name staff_company_name,
	rl.fdid role_id ,rl.role_name
	from staff st ,roles rl,company cp ,staff2roles sr, staff2company sc
	where st.fdid = sr.staff_id and sr.role_id = rl.fdid and st.fdid = sc.staff_id 
	and sc.company_id = cp.fdid and st.staff_number = #{staff_number} and st.passwd =#{passwd_mm}
	</select> 
	<!-- 新建申报周期 -->
	<insert id="createSubCycle" parameterType="com.bw.fit.common.models.SystemCommonModel">
	insert into sub_cycle (fdid,cycle_name,org_id,start_date,end_date,isdeleted,state,create_time,version_time,creator)
	values (#{fdid},#{temp_str2},#{temp_str3},to_date(#{start_date},'yyyy-mm-dd'),to_date(#{end_date},'yyyy-mm-dd'),
	'0','2',to_date(#{create_time},'yyyy-mm-dd hh24:mi:ss'),to_date(#{create_time},'yyyy-mm-dd hh24:mi:ss'),#{staff_id})
	</insert>
	<select id="checkCompanyExisteSubCycle" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		   select start_date,end_date ,cp.company_name from sub_cycle sc,company cp 
    where sc.org_id = cp.fdid and org_id =#{temp_str3}  and sc.isdeleted='0'  
		</select>
		<!-- 周期列表 -->
		<select id="qryAllCycleInfoList"  parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select * from ( select fdid,cycle_name,to_char(start_date,'yyyy-MM-dd') start_date, to_char(end_date,'yyyy-MM-dd') end_date,to_char(create_time,'yyyy-MM-dd hh24:mi:ss') create_time,
(select staff_name from staff where fdid = a.creator) temp_str1,
(select company_name from company a where a.fdid = org_id) select_company_name,
(case a.state when '2' then '已开启' when '1' then '已关闭' else '其他' end) temp_str3 ,rownum pageno from sub_cycle a where 1=1 and isdeleted='0'
 		 <if test="cycle_name !='-9'">
  				and   cycle_name  like  '%'||#{cycle_name}||'%'   
 		 </if> 
 		 <if test="temp_str1 !='-9'">
 		 and org_id  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 		 </if>
 		 )  cc where 1=1    		
 		 <if test="end_num !='-9'">
  				<![CDATA[  and cc.pageno > #{start_num} and cc.pageno<= #{end_num} ]]>
  		</if>      
		</select>
		<!-- 删除申报周期 -->
		<update id="deleteSubCycle"  parameterType="com.bw.fit.common.models.SystemCommonModel">
		update sub_cycle set isdeleted='1' ,version_time=to_date(#{version_time},'yyyy-mm-dd hh24:mi:ss'),operator=#{staff_id} where 1=1 		
 		 <if test="temp_str1 !='-9'">
 		 and fdid  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 		 </if>
		</update>
		<update id="openOrCloseSubCycle"  parameterType="com.bw.fit.common.models.SystemCommonModel">
		update sub_cycle set state = #{temp_str2} 
		 <if test="temp_str1 !='-9'">
 		 where fdid  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 			</if>
		</update>
		<!-- 根据角色查询拥有的补贴类型 -->
		<select id="getRoleDeSubType"    parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select distinct type_cd fdid from role2sub_type where role_id =#{role_id}		
		</select>
		<delete id="deleteRoleDeSubType"   parameterType="com.bw.fit.common.models.SystemCommonModel">
		delete from role2sub_type where role_id =#{role_id}		
		</delete>
		<!-- 角色与类型进行关联 -->
		<insert id="createRole2SubType"  parameterType="com.bw.fit.common.models.SystemCommonModel">
		insert into role2sub_type (role_id,type_cd) values (#{role_id},#{temp_str3})
		</insert>
		<!-- 查询申报人基础信息 -->
		<select id="getPsnBaseInfo"  parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
    select a.person_name person_name ,a.phone person_phone,a.gender person_gender,a.nation person_nation,a.orgin person_orgin,to_char(a.first_time,'yyyy-MM-dd') first_time,a.state person_state,
(select company_name from company where fdid = a.create_company) select_company_name,
(select staff_name from staff where fdid = a.creator) staff_name ,card_id ,
a.create_time from rpt_person  a where card_id = #{card_id}   
		</select>
		<!-- 修改申报人基础信息 -->
		<update id="changePsnBaseInfo" parameterType="com.bw.fit.common.models.SystemCommonModel" 	>
		update rpt_person  set person_name=#{person_name},phone=#{person_phone},gender=#{person_gender},first_time=to_date(#{first_time},'yyyy-MM-dd'),
state = #{person_state} where card_id = #{card_id}
		</update>
		<!-- 获取该用户拥有的申报类型 -->
		<select id="getRptValueByStaff" parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
         	select  si.fdid temp_str1,si.item_name temp_str2  
from staff st,  staff2roles sr,   roles rr,role2sub_type rt,sys_item si  where 
st.fdid = sr.staff_id and sr.role_id = rr.fdid and rr.fdid = rt.role_id and rt.type_cd = si.fdid and si.itype = 'SUB_TYPE' and 
st.fdid = #{staff_id}
		</select>
		<select id="getCompany2SubCycle"  parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
         	select sl.fdid temp_str1,sl.cycle_name temp_str2
from staff st,staff2company sc,sub_cycle sl
where st.fdid = sc.staff_id and sc.company_id = sl.org_id and sl.isdeleted='0' and sl.state='2' and st.fdid = #{staff_id}         	
         	</select>
         	<!-- 查看这个身份证号码是否已经存在 -->
         	<select id="getExistsPsn"   parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
           select * from rpt_person where card_id = #{card_id}
         	</select>
         	<!-- 新增申报人申报记录 -->
         	<insert id="createOldPersonRptRecond"  parameterType="com.bw.fit.common.models.SystemCommonModel" 	>
         	insert into rpt_reconds (fdid,person_name,card_id,unit_type,unit_name,pay_start,pay_end,sub_cycle,rpt_type,isdeleted,create_time,version_time,creator)
values (#{fdid},#{person_name},#{card_id},#{person_unit_type},#{person_unit},
 #{rpt_start} , #{rpt_end} ,#{rpt_cycle},#{rpt_type},'0',
to_date(#{create_time},'yyyy-MM-dd hh24:mi:ss'),to_date(#{create_time},'yyyy-MM-dd hh24:mi:ss'),#{staff_id} )
         	</insert>
         	<!-- 新增申报人基础资料 -->
         	<insert id="createPersonInfo"   parameterType="com.bw.fit.common.models.SystemCommonModel" 	>
         	insert into rpt_person (card_id,person_name,phone,gender,nation,orgin,first_time,state,create_company,creator,create_time,version_time)
values (#{card_id},#{person_name},#{person_phone},#{person_gender},#{person_nation},#{person_orgin}, to_date(#{first_time},'yyyy-MM-dd') ,'2',
#{staff_company_id} ,#{staff_id},to_date(#{create_time},'yyyy-MM-dd hh24:mi:ss'),to_date(#{create_time},'yyyy-MM-dd hh24:mi:ss') )
         	</insert>
         	<!-- 根据角色，机构等查询待审核列表 -->
         	<select id="qryWaitCheckRecordList"   parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
         	    select cc.* from (    SELECT A.ID_ AS TASK_ID,
       A.PROC_INST_ID_ PROC_INST_ID, 
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='fdid'  ) fdid,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='person_name'  ) person_name,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='card_id'  ) card_id,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='pay_start'  ) start_date,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='pay_end'  ) end_date,
       (select st.staff_name from  act_hi_varinst ,staff st where proc_inst_id_ = a.proc_inst_id_ and name_ ='creator' and st.fdid=text_   ) staff_name,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='create_time'  ) create_time,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='create_company'  ) staff_company_id ,
       (select cp.company_name from  act_hi_varinst ,company cp where proc_inst_id_ = a.proc_inst_id_ and name_ ='create_company' and cp.fdid = text_  ) staff_company_name , 
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='rpt_type'  ) rpt_type, 
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='sub_cycle'  ) rpt_cycle,rownum pageno
  FROM ACT_RU_TASK A ,staff2roles sr  ,sys_item si
  where 1=1   and a.assignee_ = si.itype and si.fdid = sr.role_id and si.itype = 'CHECKER1' and sr.staff_id = #{staff_id} ) cc
  where 1=1 
  			<if test="person_name !='-9'">
 		 		and  cc.person_name like '%'||#{person_name}||'%'  
 		 </if>
  			<if test="card_id !='-9'">
 		 		and  cc.card_id like '%'||#{card_id}||'%'  
 		 </if>
 		 <if test="temp_str1 !='-9'">
 		 and cc.staff_company_id  in
  			<foreach item="item" index="index" collection="temp_list" open="(" separator="," close=")">  
  					#{item}  
 			</foreach>    
 		 </if>
  			<if test="rpt_type !='-9'">
 		 		and  cc.rpt_type like '%'||#{rpt_type}||'%'  
 		 </if>
  			<if test="rpt_cycle !='-9'">
 		 		and  cc.rpt_cycle like '%'||#{rpt_cycle}||'%'  
 		 </if>		
 		 <if test="end_num !='-9'">
  				<![CDATA[  and cc.pageno > #{start_num} and cc.pageno<= #{end_num} ]]>
  		</if>      
         	</select>
         	<!-- 根据flowid查询该申报人身份证号码 -->
         	<select id="getCardInfoByFlowId"   parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
         	  select text_  card_id from act_hi_varinst av where   av.name_ ='card_id' and av.proc_inst_id_ =#{temp_str1}
         	  </select>
         	 <!-- 根据acitivi内部流程编码查询，这个流程记录里的数据 -->
         	 <select id="getThisCheckInfoAll"   parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
         	   SELECT 
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='fdid'  ) fdid,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='person_name'  ) person_name,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='card_id'  ) card_id,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='pay_start'  ) start_date,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='pay_end'  ) end_date,
       (select st.staff_name from  act_hi_varinst ,staff st where proc_inst_id_ = a.proc_inst_id_ and name_ ='creator' and st.fdid=text_   ) staff_name,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='create_time'  ) create_time,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='create_company'  ) staff_company_id , 
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='rpt_type'  ) rpt_type, 
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='sub_cycle'  ) rpt_cycle ,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='unit_type'  ) person_unit_type ,
       (select text_ from  act_hi_varinst where proc_inst_id_ = a.proc_inst_id_ and name_ ='unit_name'  ) person_unit 
  FROM ACT_RU_TASK A   where A.PROC_INST_ID_ =#{temp_str1}
         	 </select> 
         	 <select id="getPhotoByFdid"    parameterType="com.bw.fit.common.models.SystemCommonModel" 	resultType="com.bw.fit.common.models.SystemCommonModel">
         	  select a.filename temp_str2,foreign_id fdid from attachment a where a.foreign_id = #{fdid}
         	  </select>
</mapper>