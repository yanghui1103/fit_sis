<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="systemAdminDAO">
	<!--用户登录 -->
	<select id="loginCheckAndBackUserInfos" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		select st.fdid staff_id,st.staff_name,st.create_time,cp.fdid staff_company_id,cp.company_name staff_company_name,
	rl.fdid role_id ,rl.role_name
	from staff st ,roles rl,company cp ,staff2roles sr, staff2company sc
	where st.fdid = sr.staff_id and sr.role_id = rl.fdid and st.fdid = sc.staff_id 
	and sc.company_id = cp.fdid and st.staff_number = #{staff_number} and st.passwd =#{passwd_mm}
	</select>
	
	<!--getThisUserAuthLists 获取权限列表 -->
	<select id="getAuthTreeList" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
		SELECT fs.fdid func_id ,fs.function_name func_name ,fs.parent_function_id
		func_p_id,fs.func_level ,fs.action func_address,fs.target
		func_target,fs.rel func_rel
		FROM staff u,staff2roles ur,role2function rf ,functions fs,function_btn fb
		WHERE u.fdid = ur.staff_id
		AND ur.role_id = rf.role_id
		AND rf.function_id = fb.function_cd
		AND fs.fdid = fb.function_cd
		AND rf.btn_cd = fb.btn_cd
		AND rf.state = fs.state
		AND fs.state = '2'
		AND fb.btn_cd = 'view'
		AND u.fdid = #{staff_id} ORDER BY func_id asc
	</select>
	  <!-- getDragWindowList获取下拉框 -->
     <select id="getDragWindowList"  parameterType = "com.bw.fit.common.models.SystemCommonModel" resultType="com.bw.fit.common.models.SystemCommonModel">
       SELECT id item_id,NAME item_name,state item_state FROM vw_sys_item a WHERE TYPE =#{item_type} and state = '2'
     </select>
      <!-- getAuthorityBtnsByThisUserService 获取到这个用户这个功能所展示的按钮 -->
 	 <select id="getAuthorityBtnsByThisUserService"  parameterType = "com.bw.fit.common.models.SystemCommonModel"  resultType="com.bw.fit.common.models.SystemCommonModel">
		SELECT rf.btn_cd ,fb.btn_name  ,CONCAT(fb.btn_cd,fb.function_cd) func_btn,fb.addr func_address,fb.btn_type  
    FROM staff uu,staff2roles ur,roles r ,role2function rf ,function_btn fb 
    WHERE uu.fdid = ur.staff_id     AND ur.role_id = rf.role_id
    AND r.fdid = rf.role_id     AND fb.function_cd = rf.function_id
    AND rf.btn_cd = fb.btn_cd    AND fb.btn_cd != 'view'
    AND r.state = '2'       AND rf.state='2'
    AND uu.fdid =#{staff_id}   AND fb.function_cd =#{func_id} 
    UNION
    SELECT rf.btn_cd  ,fb.btn_name  ,CONCAT(fb.btn_cd,fb.function_cd) func_btn,fb.addr func_address,fb.btn_type  
    FROM staff uu,staff2roles ur,role2function rf ,function_btn fb
    WHERE uu.fdid = ur.staff_id   
      AND fb.function_cd = rf.function_id
    AND rf.btn_cd = fb.btn_cd  
    AND rf.role_id = '*'
      AND fb.btn_cd != 'view'
    AND rf.state='2'
    AND uu.fdid =#{staff_id}   AND fb.function_cd =#{func_id}  
 	 </select>
      <!-- 获取当前用户所在机构（用到组织架构中） -->
      <select id="getThisOrgTreeStructs"  parameterType = "com.bw.fit.common.models.SystemCommonModel" resultType="com.bw.fit.common.models.SystemCommonModel">
       select a.fdid staff_company_id,a.company_name staff_company_name,a.parent_company_id staff_parent_company_id,decode(a.state,'2',1,0) func_click
      from company a   where a.fdid = #{staff_parent_company_id}  and isdeleted= '0'       
      </select>
 	 <!-- 用户，角色，功能得出查询等级-->
 	 <select id="getCustomOrgTreeLevel"   parameterType = "com.bw.fit.common.models.SystemCommonModel"  resultType="com.bw.fit.common.models.SystemCommonModel">
       	 select rq.level_code func_level
      from staff2roles sr,role2function2qrylevel rq 
      where sr.role_id = rq.role_id and sr.staff_id = #{staff_id} and rq.function_id= #{func_id}
 	 </select>
      <!-- 获取组织架构树 -->
      <select id="getOrgTreeStructs" parameterType = "com.bw.fit.common.models.SystemCommonModel" resultType="com.bw.fit.common.models.SystemCommonModel">
       select a.fdid staff_company_id,a.company_name staff_company_name ,a.parent_company_id staff_parent_company_id,decode(a.state,'2',1,0) func_click,admin_phone temp_str1
      from company a       where a.fdid = #{staff_parent_company_id}  and isdeleted= '0'
		union
      select a.fdid staff_company_id,a.company_name staff_company_name ,a.parent_company_id staff_parent_company_id,decode(a.state,'2',1,0) func_click,admin_phone temp_str1
  		from company a connect by a.parent_company_id = prior a.fdid start with a.parent_company_id = #{staff_parent_company_id} and isdeleted='0'
      </select>
            <!--  获取功能树及选中 -->
      <select id="getFunctionsTreeStructs"  parameterType = "com.bw.fit.common.models.SystemCommonModel"  resultType="com.bw.fit.common.models.SystemCommonModel">
		SELECT fs.fdid func_id,fs.parent_function_id func_p_id,fs.function_name func_name,
    (SELECT COUNT(1) FROM role2function rf WHERE rf.function_id = fs.fdid AND rf.role_id =#{role_id}
    AND rf.btn_cd ='view') func_check ,0 temp_str1
    FROM functions fs
    WHERE fs.state = '2' 
    UNION 
    SELECT fb.fdid func_id,fb.function_cd func_p_id,fb.btn_name  func_name,
    (CASE WHEN (SELECT COUNT(1) FROM role2function rf2 WHERE rf2.function_id = fb.function_cd  AND fb.btn_cd = rf2.btn_cd 
    AND rf2.role_id =#{role_id} AND rf2.btn_cd !='view' ) = 0 THEN 0 ELSE 1 END ) func_check,0 temp_str1
    FROM function_btn fb ,functions ff
    WHERE  fb.function_cd = ff.fdid AND ff.state ='2' AND fb.btn_cd !='view'
     </select>
     <!-- 修改密码 -->
 	 <update id="changePasswd"     parameterType = "com.bw.fit.common.models.SystemCommonModel" >
		update staff set passwd = #{temp_str1} where fdid = #{staff_id}  	 
 	 </update>
 	 <update id="clearPasswd"   parameterType = "com.bw.fit.common.models.SystemCommonModel" >
 	 update staff set passwd = #{temp_str1} where staff_number = #{staff_number}  	
 	 </update>
 	 <!-- 检查工号是否存在 -->
 	 <select id="checkPersonExists" parameterType = "com.bw.fit.common.models.SystemCommonModel"  resultType="com.bw.fit.common.models.SystemCommonModel">
		select * from staff where staff_number = #{staff_number} and isdeleted='0'
		</select>     
	<insert id="createNewSysOrg" parameterType = "com.bw.fit.common.models.SystemCommonModel"  >
      insert into company (fdid,company_name ,address,state,isdeleted,company_type_cd,parent_company_id,create_time,version_time,creator,operator) values (
	#{fdid},#{staff_company_name},#{temp_str1},'2','0',#{temp_str2},#{staff_parent_company_id},to_date(#{create_time},'yyyy-mm-dd hh24:mi:ss'),to_date(#{create_time},'yyyy-mm-dd hh24:mi:ss'),#{staff_id},#{staff_id})
      </insert>
	<!-- 获取机构信息列表 -->
	<select id="getAllOrgs" parameterType="com.bw.fit.common.models.SystemCommonModel"
		resultType="com.bw.fit.common.models.SystemCommonModel">
    select * from (
     select a.fdid select_company_id,a.company_name select_company_name, 
     (select  name from company_type where fdid = a.company_type_cd and isdeleted='0')temp_str1,
     (select b.company_name from company b where  a.parent_company_id = b.fdid   ) temp_str2,a.create_time
    ,rownum pageno
     from company a where  isdeleted='0' 
 		 <if test="select_company_name !='-9'">
  				and  a.company_name  like '%'||#{select_company_name}||'%'  
  		</if>
  		)  cc where 1=1    		
 		 <if test="end_num !='-9'">
  				<![CDATA[  and cc.pageno > #{start_num} and cc.pageno<= #{end_num} ]]>
  		</if>
	</select>	
	<!-- 删除组织 -->
	<update id="deleteSelectedOrgs"  parameterType="com.bw.fit.common.models.SystemCommonModel">
	update company set isdeleted='1',version_time=to_date(#{version_time},'yyyy-mm-dd hh24:mi:ss'),operator=#{staff_id}  where fdid = #{select_company_id}
	</update>
</mapper>